name: Secrets Setup

on:
  workflow_dispatch:
    inputs:
      supabase_service_role_key:
        description: 'SUPABASE_SERVICE_ROLE_KEY (will be stored as a repo secret)'
        required: true
      primary_sensor_url:
        description: 'PRIMARY_SENSOR_URL (e.g. https://primary-sensor.example or use-synthetic)'
        required: true

jobs:
  create-secrets:
    name: Create repository secrets (manual)
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    env:
      # This workflow requires an ADMIN_TOKEN repository secret to exist ahead of time.
      # ADMIN_TOKEN should be a GitHub PAT with `repo` and `admin:repo_hook` scopes
      # (or equivalent) so it can create/update repository secrets. Do NOT store the
      # SUPABASE key directly in this repo — use this workflow to add it securely.
      ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install GH CLI
        uses: cli/gh-action@v2

      - name: Create/Update secrets via gh
        env:
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          export GH_TOKEN="$ADMIN_TOKEN"
          echo "Updating SUPABASE_SERVICE_ROLE_KEY..."
          echo "${{ github.event.inputs.supabase_service_role_key }}" | gh secret set SUPABASE_SERVICE_ROLE_KEY --repo $GITHUB_REPOSITORY
          echo "Updating PRIMARY_SENSOR_URL..."
          echo "${{ github.event.inputs.primary_sensor_url }}" | gh secret set PRIMARY_SENSOR_URL --repo $GITHUB_REPOSITORY

      - name: Success
        run: |
          echo "Repository secrets updated. Verify in repository Settings → Secrets and variables → Actions."
