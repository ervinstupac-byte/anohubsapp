# System Manifest — The Conscious Map

This document is the canonical, human-readable expression of the system's expected runtime shape, core processors, and architectural intents. It is the single authoritive artifact that the runtime `ProjectStateContext` (the Living Brain) will instantiate and that the `SovereignArchitectReflector` will compare against to detect architectural drift.

## Canonical Model
- Primary data model: `TechnicalProjectState` defined in `src/core/TechnicalSchema.ts` (Sovereign NC-5.0 canonical location).
- The `TechnicalProjectState` contains the authoritative structure: `identity`, `hydraulic`, `mechanical`, `physics`, `governor`, `site`, `penstock`, `structural`, `market`, and `financials`.

## The Brain (Core Analytical Processors)
- `PhysicsEngine` — located at `src/core/PhysicsEngine` — is the primary physics calculator used to derive deterministic telemetry and physics results.
- `FinancialImpactEngine` — located at `src/services/FinancialImpactEngine.ts` — is the economic valuation engine that consumes a `TechnicalProjectState` and `PhysicsResult` to compute lost revenue, maintenance cost, and ROI metrics.

## NC-5.0 Structural Rationale (Why)
- Purpose: Move from a flat artifact layout to a modular, intention-revealing architecture. This separation clarifies responsibilities, improves tree-shakeability, and makes the canonical model (`TechnicalProjectState`) and high-fidelity processors (physics, financials, predictions) trivially discoverable.
- Key principles:
  - Single Source of Truth: `src/core` contains canonical models and universally shared core processors.
  - Services: `src/services` contains business logic, integrations, and long-running engines (AI, reporting, forensics).
  - Contexts: `src/contexts` contains React providers and singleton managers (including `ProjectStateContext`).
  - Features: `src/features` groups UI-first feature slices (dashboard, 3d-render, telemetry, reporting).
  - Shared: `src/shared` contains UI primitives, hooks, and util functions reused across features.

This document is now the Sovereign NC-5.0 Standard for repository layout; the `SovereignArchitectReflector` will validate the presence and paths of these modules during audits.

## Self-Reflection
- `SovereignArchitectReflector` — `src/services/SovereignArchitectReflector.ts` — performs codebase audits by scanning the `src/` tree. It uses type/AST heuristics (when `typescript` is available) and filename/content heuristics to identify subsystems, probabilistic code usage, and potential missing capabilities. The manifest is referenced to detect "Architectural Drift" when the codebase diverges from this document.

## Data Flow (Runtime loop)
1. UI components consume state via React contexts (notably `TelemetryContext`, `AssetContext`, and `AIPredictionContext`).
2. `TelemetryContext` aggregates live telemetry (from Supabase realtime or deterministic `PhysicsEngine` simulation) and exposes mutators (`updatePipeDiameter`, `updateWicketGateSetpoint`, etc.).
3. `ProjectStateContext` (the Living Brain) consolidates telemetry, asset metadata, and the `DEFAULT_TECHNICAL_STATE` into a unified `TechnicalProjectState` snapshot. It also runs `PhysicsEngine.recalculatePhysics()` to enrich the canonical state.
4. `AIPredictionService` and `FinancialImpactEngine` consume the canonical `TechnicalProjectState` from `ProjectStateContext` (preferred) or from explicit parameters. Predictions (RUL, cavitation risk, efficiency decay) are computed and persisted in `AIPredictionContext` for UI consumption.
5. Prescriptive actions generated by the prediction engine (autonomous work orders, immediate actions) call back into `TelemetryContext` mutators to close the loop.

## Manifest Machine-Readable Example
Include an explicit expected subsystem list that the reflector will use for drift checks. Keep this list authoritative and update when adding/removing major modules.

```json
{
  "expectedSubsystems": [
    "ShaftSealGuardian",
    "ThrustBearingMaster",
    "ThermalManagementCore",
    "GovernorHPUGuardian",
    "GeneratorAirGapSentinel",
    "StatorInsulationGuardian",
    "TransformerOilGuardian"
  ]
}
```

## How to update
- Edit this `SystemManifest.md` to add or remove expected subsystems and to document any new core processors. The `SovereignArchitectReflector` will surface mismatches during audits.

## Intent
- This manifest is the soul of the system. The `ProjectStateContext` is the living runtime that expresses this soul to engines and the UI. Use them together to keep the codebase consistent and observable.

## Experience Lab (User Input Entry Point)
- Path: `/experience-lab`
- Purpose: A developer-facing sandbox to capture user inputs, experimental scenarios, and quick diagnostics. The Experience Lab writes into the `TelemetryContext` (via mutators) and is expected to provide a predictable interface to the `ProjectStateContext` for live experiments.
- UI Entry (recommended): `src/components/ExperienceLab/ExperienceLab.tsx` which should expose a small form for injecting telemetry and scenario controls.

The `SovereignArchitectReflector` will check for an Experience Lab entry when validating the manifest; if absent, it will flag the manifest drift as a missing developer UX entry.

## Files Touched in NC-5.0 Reorganization
- `SystemManifest.md`
- `src/contexts/ProjectStateContext.tsx` (migrated and verified against canonical API)
- `src/services/SovereignArchitectReflector.ts`
- `src/services/FinancialImpactEngine.ts`
- `src/services/AIPredictionService.ts`
- `src/components/dashboard/ExecutiveDashboard.tsx`
- `src/contexts/TelemetryContext.tsx`

## Repomix Snapshot (archived)
- Location: `docs/archive/repomix/repomix-output.xml` and `docs/archive/repomix/repomix-output.zip` (moved from repository root).
- Notes: The repomix snapshot is a read-only, merged representation of the repository used for large-scale analysis. It contains a full file list, many generated assets, and duplicate root-level copies of schematics. It should not be referenced at runtime — treat it as an audit snapshot only.

## Schema Discrepancies — `supabase_schema.sql` vs `src/core/TechnicalSchema.ts`
- Matches:
  - `public.assets` maps to the in-memory `AssetIdentity`/`assetPassport` concept; both carry `name`, `type`/`turbine_type`, `location`, basic geo fields and a JSONB `specs` which aligns with `assetPassport`/`machineConfig` in `TechnicalSchema`.
  - `expert_knowledge_base`, `experience_ledger`, and `audit_logs` have conceptual equivalents in the codebase (diagnosis messages, resolution history, and auditing) but are implemented as in-memory or service-layer artifacts rather than strict persisted tables for every field.
- Discrepancies / Gaps (recommendations):
  1. No explicit persistent table for high-frequency telemetry/time-series (e.g., vibration, bearingTemp, hydraulic samples). `TechnicalSchema` expects rich numeric streams (`HydraulicStream`, `MechanicalStream`, `acousticMetrics`) — consider adding a `telemetry_samples` or `time_series` table for efficient ingestion and retention.
  2. No `physics_results` persistent table. `PhysicsEngine` produces `PhysicsResult` (hoopStress, powerMW, surgePressure, eccentricity, volumetricLoss, boltLoadKN, etc.). Persisting summaries would aid audits and historical queries.
  3. `component_health` or similar table is absent. `TechnicalSchema` maintains `ComponentHealthRegistry` and per-component health records; a dedicated persisted registry would make trend queries and maintenance workflows simpler.
  4. `project_state` canonical persistence: `TechnicalProjectState` is rich and large — if you need a canonical persisted snapshot for restores/audits, add a `project_state_snapshots` table (JSONB) with `created_at`, `source`, and `checksum`.
  5. `governor`/`governor_state` high-precision fields (Decimal) are in-memory; persisted representation and migration strategy should be defined if you rely on exact-repeatability for audits.
  6. `work_orders` and `work_order_steps` exist in `supabase_schema.sql` but the in-memory model references only `investigatedComponents` and generated work items. Ensure field alignment (status enums and step granularity) if you intend to reconcile UI-generated work orders with DB records.

- Minor differences:
  - `supabase_schema.sql` defaults `turbine_type` to `'francis'` while `DEFAULT_TECHNICAL_STATE.identity.turbineType` uses `'PELTON'` in the default. This is a data default mismatch that can be normalized in ingestion.
  - `supabase_schema.sql` uses `specs JSONB` for extensible fields — this aligns well with `TechnicalSchema`'s `assetPassport` and `machineConfig` JSON-like structures; keep this mapping stable.

## Actions taken in this pass
- Moved root-level duplicate schematics (`Francis_manje_5.svg`, `geno_fr_h_manje_od_5.svg`) to `docs/archive/assets/legacy_inputs/` to keep `public/` as the canonical served location and to remove stray root duplicates.
- Moved `repomix-output.xml` and `repomix-output.zip` to `docs/archive/repomix/`.
- Moved `test_results.json` to `test-results/test_results.json`.

## Runtime Integrity

- Date: 2026-01-23 — NC-5.8 runtime alignment actions.
- Repaired modules so runtime no longer references removed `public/archive` roots and so archival assets resolve to the preserved `docs/archive` location.
- Files changed:
  - `src/data/knowledge/DossierLibrary.ts`: updated path resolution to return `/docs/...` absolute paths when manifest entries point at `docs/...` (preserves NC-5.7 archival mapping).
  - `src/components/knowledge/DossierViewerModal.tsx`: expanded fallback mapping to prefer `/docs/archive/*`, and improved integrity messaging.
  - `scripts/hashes_applied.json`: updated to reference `docs/archive/...` with `"archived": true` metadata.
  - `docs/archive/case_studies/*`: preserved case study HTMLs copied from `public/archive`.

These repairs aim to prevent runtime fetches to now-removed `/public/archive` assets and instead resolve to the committed archival copy under `docs/archive/` for auditing and developer inspection.

## Suggested next steps
- Add lightweight `telemetry_samples` and `physics_results` tables (or a single `observations` table) if historical analysis on numeric streams is required.
- Create migration notes that map `TechnicalProjectState` fields to JSONB persistence shapes for snapshots/backfills.
- Verify UI references to any moved root duplicates; the canonical public copies remain at `public/assets/schematics/francis-h5/`.

## Database Connectivity

This section documents current connectivity between the codebase and the database schema (tables present in `supabase_schema.sql` and other DB tables referenced in code). The goal is to achieve traceability: every persisted table should have a clear code-level usage or be a candidate for archival.

- `public.assets`: CONNECTED — used by `src/contexts/AssetContext.tsx`, `src/contexts/TelemetryContext.tsx`, UI components; maps to `AssetIdentity`/`assetPassport` in `TechnicalSchema`.
- `public.inventory_assets`: CONNECTED — used by `src/contexts/InventoryContext.tsx` for spare parts/inventory flows.
- `public.work_orders`: CONNECTED — used by `src/contexts/WorkOrderContext.tsx`, `src/contexts/MaintenanceContext.tsx` for creating/updating work orders and realtime subscriptions.
- `public.work_order_steps`: CONNECTED — used by `src/contexts/WorkOrderContext.tsx` (joined as `steps:work_order_steps(*)`).
- `public.expert_knowledge_base`: CONNECTED — used by `src/contexts/DiagnosticContext.tsx` to resolve symptom keys to recommended actions.
- `public.experience_ledger`: CONNECTED — used by `src/contexts/DiagnosticContext.tsx` to persist resolved cases/experience entries.
- `public.audit_logs`: CONNECTED — used by `src/contexts/AuditContext.tsx` for audit queries/inserts.
- `public.diagnostic_drafts`: CONNECTED — used by `src/components/Questionnaire.tsx` and diagnostic flows to persist draft answers.

Additional DB tables referenced by the code but not present in `supabase_schema.sql` (candidate schema additions or managed by other migrations/services):

- `telemetry_history_cache` — heavily referenced in `src/components/dashboard/ExecutiveDashboard.tsx`, `src/services/AIPredictionService.ts`, `src/components/dashboard/CenturyROIChart.tsx`. Purpose: precomputed telemetry time-series cache for dashboard and AI services. Status: REFERENCED but absent from `supabase_schema.sql` (add to canonical schema or document migration provenance).
- `hpp_status` / realtime channel `realtime_hpp_status` — used by `TelemetryContext.tsx` realtime subscriptions to map realtime updates to `TelemetryData`. Status: REFERENCED; runtime realtime channel expected to exist in Supabase realtime configuration.

Migration drafts created in this pass:

- `supabase/migrations/20260123_sovereign_memory.sql` — DDL draft for `telemetry_samples`, `physics_results`, and `project_state_snapshots`. These tables are intended to provide durable time-series and physics result storage for auditing and model reproducibility.

Candidates for Deprecation/Archiving:

- None found in `supabase_schema.sql` — all tables in the current `supabase_schema.sql` are referenced in `src/` and have a functional purpose.

Recommendations:

- Promote `supabase/migrations/20260123_sovereign_memory.sql` from draft to reviewed migration and apply to the Supabase instance to support historical telemetry and physics persistence.
- Consolidate a single canonical SQL schema file (or generated migrations) that includes `telemetry_history_cache` and `hpp_status` configuration so `SystemManifest.md` and `supabase_schema.sql` remain synchronized.
- Add a brief mapping document (or extend this manifest) that explicitly maps `TelemetryData` (in-memory) fields to `telemetry_samples` columns and to `telemetry_history_cache` JSON shapes so future audits can verify field-level parity.

## NC-5.7 Structural Overhaul — COMPLETED, TESTED, and ARCHIVED

- Status: COMPLETED
- Verification: All local behavioral tests (Vitest) passed — 100% green after archival sync.
- Action summary:
  - Moved legacy `public/archive/case-studies/*` assets into `docs/archive/case_studies/` for long-term preservation and auditability.
  - Updated `scripts/hashes_applied.json` to point to `docs/archive/...` with `"archived": true` flags and preserved normalized SHA-256 checksums.
  - Created helper scripts for recomputing normalized hashes and manifest updates.
- Notes: The archival move is non-destructive in the commit history (files are removed from `public/` and preserved in `docs/`), and the manifest now references archived paths for integrity checking.

Commit and deployment instructions: after reviewing these changes locally, run:

```
git add .
git commit -m "NC-5.7: Structural Overhaul Completed - 100% Test Pass - Knowledge Base Archived"
git push origin main
```

After push, verify your deployment (Vercel/GitHub Pages) and confirm production availability. Record the commit hash here for traceability.


